<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<!--
			This file is licensed under the Creative Commons Attribution-ShareAlike 2.5 Generic license.
		-->

		<title>reveal.js - The HTML Presentation Framework</title>

		<meta name="description" content="A framework for easily creating beautiful presentations using HTML">
		<meta name="author" content="Hakim El Hattab">

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<link rel="stylesheet" href="css/reveal.min.css">
		<link rel="stylesheet" href="css/theme/default.css" id="theme">

		<!-- For syntax highlighting -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- If the query includes 'print-pdf', include the PDF print sheet -->
		<script>
			if( window.location.search.match( /print-pdf/gi ) ) {
				var link = document.createElement( 'link' );
				link.rel = 'stylesheet';
				link.type = 'text/css';
				link.href = 'css/print/pdf.css';
				document.getElementsByTagName( 'head' )[0].appendChild( link );
			}
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body class="language-markup">

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">
				<section data-markdown data-separator="^---$">
					<script type="text/template">
						<img src="img/gardr.svg" alt="Garðr logo" style="height: 200px" />
						#### Multichannel responsive HTML5-ads without choking

						<small>
							by<br/>Gregers Gram Rygg<br/>
							Frontend Core Team - FINN.no<br/><br/>
							[@gregersrygg](http://twitter.com/gregersrygg)
						</small>

						note:
						* Who am I?
							* New team
							* kart
							* async banner loading

						---

						## ads @ FINN.no

						1. (Advertisment spec)<!-- .element: class="fragment" -->
						2. (Garðr validator)<!-- .element: class="fragment" -->
						3. Garðr client library<!-- .element: class="fragment" -->
					</script>
				</section>

				<section data-markdown="advertsspec.md" data-separator="^---$" data-vertical="^--$">
				</section>

				<section>
					<iframe src="http://validator.finn.no/" style="width:800px;height:500px;"></iframe>

					<aside class="notes">
						For both ad producers and publishers
					</aside>
				</section>

				<section data-markdown data-separator="^---$">
					<script type="text/template">
						## Garðr client library

						1. What/Why Garðr?
							* Performance<br/>
							* User protection<br/>
							* Site protection<br/>
							* Multi-plattform ads (web & apps)<br/>
							* Maintainable & extensible
						2. How?
						3. Code plz!!!1

						---

						## 2010

						---

						<!-- .slide: data-background="#fff" -->

						Note: What finn.no looked like when one ad-server was slow or down

						---

						<!-- .slide: data-background="#fff" -->
						![Network graph outlining ad requests](img/2010.png)

						Note: explain blocking requests and “start render”

						---

						* Single point of failure
						* Ads block rendering and use > 40% of our rendering time
							* Servers in Germany creates latency
					</script>
				</section>

				<section>
					<h2>1st attempt (jan 2010)</h2>
					<img class="stretch" src="img/kart.png" alt="Screenshot of kart.finn.no with an ad" />

					<aside class="notes">
						Single page web-app<br/>
						Lots of javascript needed to show a map<br/>
						Had spent lots of time optimizing load-time<br/>
						Loading ads the “normal” way would slow down load-time significantly
					</aside>
				</section>

				<section>
					<h2>How most ads are loaded</h2>
					<small>
					<code>
						&lt;script src="http://adserver.com/lotsofparameters"&gt;&lt;/script&gt;
					</code>
					</small>
				</section>

				<section data-markdown>
					<script type="text/template">
						## Why is that so slow?

						* `<script>`-tags block by default because of `document.write`
						* Ads use `document.write` A LOT!
							* So `defer`- or `async`-attribute will fail
					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
						## document.write?

						<pre><code>&lt;script type="text/javascript"&gt;
								document.write( "<div>awesome ad!</div>" );
						&lt;/script&gt;
						</code></pre>
						<pre><code><div>awesome ad!</div></code></pre> <!-- .element: class="fragment" -->
						<pre><code><div>Page content</div></code></pre>


						> Writes a string of text to a document stream...
						>
						> &mdash; <cite>[Mozilla Developer Network][1]</cite>

						[1]: https://developer.mozilla.org/en-US/docs/Web/API/document.write
					</script>
				</section>

				<section data-markdown data-separator="^---$">
					<script type="text/template">
						### Simple! Just replace `document.write`

						```
var stringToWrite = ""; // buffer
var timer = null;       // setTimeout reference

// overwrite document.write
document.write = function(str) {
  clearTimeout(timer);             // stop previous setTimout
  stringToWrite += str;            // add str to buffer
  timer = setTimeout(flush, 100);  // flush buffer in 100 ms
};

function flush() {
  $j("#ad-container").html(stringToWrite).show();
}

$j.getScript(bannerUrl);
						```

						Note:
						I heard others (google + others) had tried and failed, but they didn't say why.
						Will also only work for 1 placement pr page

						---

						## Whops, not so simple :/

						```
document.write("<div id=\"foo-bar\"></div>");
// now the div is in the buffer instead of the document
document.getElementById("foo-bar").innerHTML = "awesome ad!";
						```

						<pre style="color:red;"><img src="img/error.svg" style="height:21px" /> TypeError: Cannot set property 'innerHTML' of null</pre>

						---

						## 2nd attempt (nov 2010)

						A more sophisticated document.write hack:
						https://github.com/gregersrygg/crapLoader

						* Works with multiple positions
						* Load (almost) any **third-party script asynchronously**
				    * Does **not block rendering** of your page
				        * Your visitors see your content earlier
				        * DOMContentLoaded (a.k.a. $(doc).ready ) and window.onload triggered earlier
				    * Load the **banners in parallel!** Except in IE ;(
				        * Banners loads faster (at least in theory)
						* Handles **recursive scripts**
						    * Inline and external javascript
						    * Inline and external vbscript
						* Buffer document.write, flush on script load event
						    * Handles document.getElementById from the buffer

						Note: Inspired after JsConf.eu

						---

						## Problems when replacing document.write
						<small>

						* You never know for sure that all ads will load correctly
						* Ads might circumvent by getting a clean doc.write from an iframe
						* Might violate the terms of your ad provider
						* You can't use document.write in your own scripts, but *why* would you?!?
						* document.getElementById will be slower until all scripts loaded with crapLoader are finished loading
						* Script contains document.write("&lt;script src=...&gt;&lt;/script&gt;"); but innerHTML doesn't execute the script.
						* Script uses document.write to output an inline script
						* Script tag is split up in multiple write calls
						* When using a write buffer, the a document.getElementById call right after it's inserted with document.write will not find the element.
						* Internet Explorer (6, 7, 8?, 9?) does not allow document.getElementById before the DOM is ready. So it's not possible to inject the content while the page is loaded.
						* Scripts loaded asynchronously might bind to document.onload or DOMContentLoaded after they have been triggered. That will cause the callbacks to never be triggered.
						* Problem: Newlines before an &lt;object&gt;-tag cause issues when injecting with innerHTML in Internet Explorer.
						* Problem: Ads may use document.open() and document.close(). Browsers ignore these when called from within a blocking script, but not when the script is run non-blocking.
						* Problem: **Ads may write a container, then load another script async. When do we restore document.getElementById?**
						* ...who knows?

						</small>
					</script>
				</section>






				<section>
					<h3>“Trusted” XSS for &nbsp;<img style="width:1.2em;position:relative;top:5px;" src="img/euro.png" alt="Screenshot of kart.finn.no with an ad" /></h3>

					<small>
						<blockquote>
							<p>“XSS enables attackers to inject client-side script into Web pages viewed by other users. A cross-site scripting vulnerability may be used by attackers to <b>bypass access controls</b> such as the <b>same origin policy</b>. Their <b>effect</b> may range from a petty nuisance to a <b>significant security risk</b>, <b>depending</b> on the <b>sensitivity</b> of the <b>data handled</b> by the vulnerable <b>site</b> and the nature of any security mitigation implemented by the site's owner.”</p>

							<footer><cite>&mdash; <a href="http://en.wikipedia.org/wiki/Cross-site_scripting">Wikipedia</a></cite></footer>
						</blockquote>
					</small>

					<aside class="notes">
						You give ads full access to do whatever they want on your site<br/>
						Layout, content, user-data, keyboard-input,...<br/>
						“Please stay within the container”
					</aside>
				</section>

				<section>
					<h2>m.finn.no</h2>

					<!--iframe src="http://m.finn.no/bap/forsale/search.html" style="width:320px; height: 568px;"></iframe-->
					<video src="video/mfinn.mov" class="stretch" style="width:600px; height:572px;" autoplay loop></video>
				</section>

				<section>
					<h2>Why Garðr</h2>
					<blockquote>
						<p><strong>garðr</strong>&nbsp;<span><abbr>m</abbr></span> (<i>genitive</i> <b>garðs</b>, <i>plural</i> <b>garðar</b>)</p>
						<ol>
							<li>a fence, wall
							<li>(especially in compounds) an enclosed space, yard
							<li>a courtyard, court
							<li>a house, dwelling
							<li>(especially in compounds) a stronghold, castle, hold
						</ol>
						<footer>
							- <cite><a href="http://en.wiktionary.org/wiki/gar%C3%B0r">Wiktionary</a></cite>
						</footer>
					</blockquote>

				</section>


				<section>
					<h1>THE END</h1>
					Gregers Gram Rygg / @gregersrygg
				</section>

			</div>

		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>

			// Full list of configuration options available here:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,

				theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
				transition: Reveal.getQueryHash().transition || 'linear', // default/cube/page/concave/zoom/linear/fade/none

				// Parallax scrolling
				// parallaxBackgroundImage: 'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg',
				// parallaxBackgroundSize: '2100px 900px',

				// Optional libraries used to extend on reveal.js
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					/*{ src: 'plugin/rainbow/rainbow.js', async: true, callback: function() { return !!document.querySelector( 'code' ); } },*/
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
					/*{ src: 'plugin/prism/prism.js', callback: function() { return !!document.querySelector('[class*=language-]'); } },*/
					{ src: 'plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
					{ src: 'plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
				]
			});

		</script>

	</body>
</html>
